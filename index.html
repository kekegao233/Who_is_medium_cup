<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å®¿å‘½æˆ˜æ£‹ - æˆ¿é—´å¯¹æˆ˜ç‰ˆ</title>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* --- ç™»å½•ç•Œé¢æ ·å¼ --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: #34495e;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-box h1 { margin: 0 0 20px 0; color: #f1c40f; }
        .login-box input {
            padding: 10px; font-size: 18px; border-radius: 5px; border: none; outline: none; text-align: center; width: 200px; margin-bottom: 15px;
        }
        .login-box button {
            padding: 10px 30px; font-size: 18px; border-radius: 5px; border: none; cursor: pointer; background: #e74c3c; color: white; font-weight: bold; transition: 0.2s;
        }
        .login-box button:hover { background: #c0392b; }

        /* --- æ¸¸æˆä¸»ç•Œé¢ (é»˜è®¤éšè—) --- */
        #main-ui { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding-top: 20px;}

        /* --- åŸæœ‰æ ·å¼ä¿æŒä¸å˜ --- */
        #status-bar { font-size: 24px; margin-bottom: 10px; font-weight: bold; display: flex; gap: 30px;}
        #turn-info { color: #f1c40f; }
        #main-area { display: flex; gap: 20px; align-items: flex-start; }
        .sidebar { width: 180px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; min-height: 400px; }
        .sidebar h3 { text-align: center; margin: 5px 0 15px 0; border-bottom: 1px solid #aaa; padding-bottom: 5px;}
        .team-title-A { color: #e74c3c; }
        .team-title-B { color: #3498db; }
        .queue-item { background: rgba(255,255,255,0.1); margin-bottom: 8px; padding: 8px; border-radius: 4px; display: flex; flex-direction: column; font-size: 14px; transition: all 0.3s; }
        .queue-item.current { background: linear-gradient(90deg, #f39c12, #e67e22); transform: scale(1.05); box-shadow: 0 0 10px #f1c40f; border: 2px solid #fff; }
        .queue-item.dead { opacity: 0.3; filter: grayscale(100%); text-decoration: line-through; }
        .q-name { font-weight: bold; font-size: 16px; }
        .q-rank { font-size: 12px; color: #ddd; margin-top: 2px; }
        #game-container { position: relative; width: 500px; height: 500px; background: #ecf0f1; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        canvas { position: absolute; top: 0; left: 0; }
        #click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        #pieces-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .piece { position: absolute; width: 44px; height: 44px; border-radius: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: auto; z-index: 11; font-size: 12px; text-align: center; line-height: 1.1; transition: all 0.3s; }
        .team-A { background: #e74c3c; color: white; border: 2px solid #c0392b; }
        .team-B { background: #3498db; color: white; border: 2px solid #2980b9; }
        .p-name { padding: 0 4px; } 
        .active { box-shadow: 0 0 0 4px #f1c40f, 0 0 20px #f1c40f; z-index: 100 !important; transform: translate(-50%, -50%) scale(1.15); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(241, 196, 15, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0px rgba(241, 196, 15, 0); } }
        .grid-click-area { position: absolute; width: 40px; height: 40px; transform: translate(-50%, -50%); border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1>å®¿å‘½æˆ˜æ£‹</h1>
            <p style="color:#aaa; font-size: 14px; margin-bottom: 20px;">è¾“å…¥ç›¸åŒæˆ¿é—´å·å³å¯å¯¹æˆ˜</p>
            <input type="text" id="room-input" placeholder="è¾“å…¥æˆ¿é—´å· (å¦‚ 666)" />
            <br>
            <button onclick="joinRoom()">è¿›å…¥æˆ˜åœº</button>
            <p id="login-msg" style="color: #e74c3c; margin-top: 10px; height: 20px;"></p>
        </div>
    </div>

    <div id="main-ui">
        <div id="status-bar">
            <span id="room-display" style="color:#aaa; font-size:18px;"></span>
            <span id="turn-info">ç­‰å¾…å¯¹æ‰‹...</span>
        </div>
        <div id="main-area">
            <div class="sidebar" id="sidebar-A">
                <h3 class="team-title-A">Aé˜Ÿè¡ŒåŠ¨è¡¨</h3>
                <div id="list-A"></div>
            </div>
            <div id="game-container">
                <canvas id="boardCanvas" width="500" height="500"></canvas>
                <div id="click-layer"></div>
                <div id="pieces-layer"></div>
            </div>
            <div class="sidebar" id="sidebar-B">
                <h3 class="team-title-B">Bé˜Ÿè¡ŒåŠ¨è¡¨</h3>
                <div id="list-B"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const GRID_SIZE = 6;  
        const BOARD_WIDTH = 500;
        const PADDING = 35;
        const STEP = (BOARD_WIDTH - PADDING * 2) / GRID_SIZE;
        let myId = null;
        let myTeam = null;

        // --- æˆ¿é—´é€»è¾‘ ---
        function joinRoom() {
            const roomId = document.getElementById('room-input').value.trim();
            if (!roomId) {
                document.getElementById('login-msg').innerText = "è¯·è¾“å…¥æˆ¿é—´å·ï¼";
                return;
            }
            // å‘é€åŠ å…¥è¯·æ±‚
            socket.emit('join_room', roomId);
        }

        // ç›‘å¬åŠ å…¥ç»“æœ
        socket.on('join_success', (roomId) => {
            // éšè—ç™»å½•é¡µï¼Œæ˜¾ç¤ºæ¸¸æˆé¡µ
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('room-display').innerText = `æˆ¿é—´: ${roomId}`;
            
            // åˆå§‹åŒ–ç»˜å›¾
            drawBoard(); initClickLayer();
        });

        socket.on('join_fail', (msg) => {
            document.getElementById('login-msg').innerText = msg;
        });

        // --- ä»¥ä¸‹æ˜¯åŸæœ‰çš„æ¸¸æˆé€»è¾‘ ---

        function renderSidebars(queues) {
            ['A', 'B'].forEach(team => {
                const container = document.getElementById(`list-${team}`);
                container.innerHTML = ''; 
                queues[team].forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'queue-item';
                    if (item.isDead) div.classList.add('dead');
                    if (item.isCurrent) div.classList.add('current');
                    div.innerHTML = `<div class="q-name">${item.name}</div><div class="q-rank">${item.rankTitle}</div>`;
                    container.appendChild(div);
                });
            });
        }

        function renderPieces(data) {
            const layer = document.getElementById('pieces-layer');
            layer.innerHTML = ''; 
            data.board.forEach(p => {
                const el = document.createElement('div');
                el.className = `piece team-${p.team}`;
                el.style.left = (PADDING + p.x * STEP) + 'px';
                el.style.top = (PADDING + p.y * STEP) + 'px';
                el.innerHTML = `<div class="p-name">${p.name}</div>`;
                el.title = `${p.name}: ${p.desc}`;
                
                if (data.turn && data.turn.x === p.x && data.turn.y === p.y) {
                    if (data.myTeam === data.turn.team) {
                        el.classList.add('active'); 
                    }
                }
                el.onclick = (e) => { e.stopPropagation(); handleGridClick(p.x, p.y); };
                layer.appendChild(el);
            });

            const turnInfo = document.getElementById('turn-info');
            if (data.winner) {
                turnInfo.innerText = "ğŸ† èƒœè€…: " + data.winner + " æ–¹";
            } else if (data.turn) {
                turnInfo.innerText = `å½“å‰å›åˆ: ${data.turn.team} æ–¹ [${data.turn.name} - ${data.turn.rankTitle}]`;
            }
            myTeam = data.myTeam;
        }

        function drawBoard() {
            const ctx = document.getElementById('boardCanvas').getContext('2d');
            ctx.clearRect(0, 0, 500, 500);
            const getPos = i => PADDING + i * STEP;

            ctx.strokeStyle = "#7f8c8d"; ctx.lineWidth = 2; ctx.lineCap = "round";
            for (let i = 0; i <= 6; i++) {
                ctx.beginPath(); ctx.moveTo(getPos(0), getPos(i)); ctx.lineTo(getPos(6), getPos(i)); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(getPos(i), getPos(0)); ctx.lineTo(getPos(i), getPos(6)); ctx.stroke();
            }

            ctx.strokeStyle = "#c0392b"; ctx.lineWidth = 5; 
            ctx.beginPath();
            // A. å·¦ä¸Šè§’ Xå‹
            ctx.moveTo(getPos(0), getPos(0)); ctx.lineTo(getPos(2), getPos(2));
            ctx.moveTo(getPos(2), getPos(0)); ctx.lineTo(getPos(0), getPos(2));
            // B. å·¦ä¸‹è§’
            ctx.moveTo(getPos(2), getPos(2)); ctx.lineTo(getPos(0), getPos(4));
            ctx.moveTo(getPos(2), getPos(2)); ctx.lineTo(getPos(2), getPos(6));
            ctx.moveTo(getPos(2), getPos(6)); ctx.lineTo(getPos(1), getPos(5));
            // C. å³ä¸Šè§’
            ctx.moveTo(getPos(3), getPos(0)); ctx.lineTo(getPos(4), getPos(1));
            ctx.moveTo(getPos(3), getPos(1)); ctx.lineTo(getPos(5), getPos(1));
            ctx.moveTo(getPos(3), getPos(2)); ctx.lineTo(getPos(5), getPos(2));
            ctx.moveTo(getPos(3), getPos(3)); ctx.lineTo(getPos(5), getPos(3));
            ctx.moveTo(getPos(3), getPos(1)); ctx.lineTo(getPos(3), getPos(6));
            ctx.moveTo(getPos(5), getPos(1)); ctx.lineTo(getPos(5), getPos(3));
            // D. å³ä¸‹è§’
            ctx.moveTo(getPos(3), getPos(3)); ctx.lineTo(getPos(6), getPos(6));
            ctx.moveTo(getPos(3), getPos(6)); ctx.lineTo(getPos(4), getPos(5));
            ctx.moveTo(getPos(5), getPos(3)); ctx.lineTo(getPos(4), getPos(4));
            ctx.stroke();
        }

        function initClickLayer() {
            const layer = document.getElementById('click-layer');
            layer.innerHTML = '';
            for(let y=0; y<=6; y++) for(let x=0; x<=6; x++) {
                const div = document.createElement('div');
                div.className = 'grid-click-area';
                div.style.left = (PADDING + x * STEP) + 'px';
                div.style.top = (PADDING + y * STEP) + 'px';
                div.onclick = () => handleGridClick(x, y);
                layer.appendChild(div);
            }
        }
        function handleGridClick(x, y) { socket.emit('move', { x, y }); }

        socket.on('connect', () => { myId = socket.id; });
        socket.on('game_init', (data) => {
            // ä»¥å‰è¿™é‡Œä¼šæ˜¾ç¤º "åŒ¹é…æˆåŠŸ"ï¼Œç°åœ¨æ”¹ä¸ºæ›´æ–°çŠ¶æ€å³å¯
            document.getElementById('turn-info').innerText = data.msg;
        });
        socket.on('update_board', (data) => {
            renderPieces(data);
            if (data.queues) renderSidebars(data.queues);
        });
        socket.on('error_msg', (msg) => alert(msg));
        socket.on('combat_effect', (res) => {
            let msg = `âš”ï¸ ${res.attackerRank} vs ${res.defenderRank}\n`;
            msg += res.winner === 'draw' ? 'åŒå½’äºå°½' : `${res.winner === 'attacker' ? 'æ”»å‡»æ–¹' : 'é˜²å®ˆæ–¹'} è·èƒœ`;
            alert(msg);
        });
    </script>
</body>
</html>