<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è°æ˜¯ä¸­æ¯ï¼Ÿ - 11.12ç‰ˆ</title>
    <style>
        body {
            background-color: #2c3e50;
            color: white;
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto; 
            padding-bottom: 50px; 
        }

        /* ç™»å½•ç•Œé¢ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: #34495e; padding: 40px; border-radius: 10px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px;
        }
        .login-box h1 { margin: 0 0 10px 0; color: #f1c40f; }
        .login-box input {
            padding: 12px; font-size: 16px; border-radius: 5px; border: none; outline: none; text-align: center; width: 220px;
        }
        .login-box button {
            padding: 12px; font-size: 18px; border-radius: 5px; border: none; cursor: pointer; background: #e74c3c; color: white; font-weight: bold; transition: 0.2s;
        }
        .login-box button:hover { background: #c0392b; }

        /* ä¸»ç•Œé¢ */
        #main-ui { display: none; width: 100%; flex-direction: column; align-items: center; padding-top: 20px;}
        #status-bar { font-size: 24px; margin-bottom: 10px; font-weight: bold; display: flex; gap: 30px;}
        #turn-info { color: #f1c40f; }

        #main-area { display: flex; gap: 20px; align-items: flex-start; }
        
        /* ä¾§è¾¹æ  (è¡ŒåŠ¨é˜Ÿåˆ—) */
        .sidebar { width: 200px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; min-height: 400px; }
        .sidebar h3 { text-align: center; margin: 5px 0 15px 0; border-bottom: 1px solid #aaa; padding-bottom: 5px; font-size: 18px;}
        .team-title-A { color: #e74c3c; }
        .team-title-B { color: #3498db; }

        .queue-item { background: rgba(255,255,255,0.1); margin-bottom: 8px; padding: 8px; border-radius: 4px; display: flex; flex-direction: column; font-size: 14px; transition: all 0.3s; }
        .queue-item.current { background: linear-gradient(90deg, #f39c12, #e67e22); transform: scale(1.05); box-shadow: 0 0 10px #f1c40f; border: 2px solid #fff; }
        .queue-item.dead { opacity: 0.3; filter: grayscale(100%); text-decoration: line-through; }
        .q-header { display: flex; justify-content: space-between; align-items: center; }
        .q-name { font-weight: bold; font-size: 16px; }
        .q-hp { font-size: 14px; color: #e74c3c; font-weight: bold; }
        .q-rank { font-size: 12px; color: #bbb; margin-top: 4px; }

        /* æ¸¸æˆæ£‹ç›˜åŒºåŸŸ */
        #game-container { position: relative; width: 500px; height: 500px; background: #ecf0f1; border-radius: 4px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        canvas { position: absolute; top: 0; left: 0; }
        #click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }
        #pieces-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* æ£‹å­æ ·å¼ */
        .piece { position: absolute; width: 44px; height: 44px; border-radius: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); pointer-events: auto; z-index: 11; font-size: 12px; text-align: center; line-height: 1.1; transition: all 0.3s; }
        .team-A { background: #e74c3c; color: white; border: 2px solid #c0392b; }
        .team-B { background: #3498db; color: white; border: 2px solid #2980b9; }
        .p-name { padding: 0 4px; } 
        
        /* å½“å‰å›åˆé€‰ä¸­æ•ˆæœ */
        .active { box-shadow: 0 0 0 4px #f1c40f, 0 0 20px #f1c40f; z-index: 100 !important; transform: translate(-50%, -50%) scale(1.15); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(241, 196, 15, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0px rgba(241, 196, 15, 0); } }

        /* ç‰¹æ®ŠçŠ¶æ€ç‰¹æ•ˆ */
        .chimera-active {
            box-shadow: 0 0 0 4px #e74c3c, 0 0 30px #e74c3c !important; 
            border-color: #c0392b !important;
            animation: chimera-pulse 0.8s infinite alternate !important;
        }
        @keyframes chimera-pulse { 0% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1.2); } }

        .grid-click-area { position: absolute; width: 40px; height: 40px; transform: translate(-50%, -50%); border-radius: 50%; cursor: pointer; }

        /* æ—¥å¿—åŒºåŸŸ */
        #log-area { width: 900px; max-height: 150px; height: 150px; background: rgba(0,0,0,0.5); margin-top: 15px; border-radius: 8px; padding: 10px; overflow-y: auto; font-size: 14px; border: 1px solid #7f8c8d; box-sizing: border-box; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }
        .log-highlight { color: #f1c40f; font-weight: bold; }
        .log-win { color: #2ecc71; }
        .log-special { color: #e74c3c; font-weight: bold; text-shadow: 0 0 5px #c0392b; }

        /* æŠ€èƒ½æŒ‰é’® */
        #skill-panel { position: absolute; bottom: 10px; right: 10px; z-index: 200; }
        .skill-btn { background: linear-gradient(45deg, #8e44ad, #9b59b6); color: white; border: 2px solid #fff; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: none; animation: bounce 2s infinite; }
        .skill-btn.targeting { background: #e74c3c; animation: none; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* ååº”å¼¹çª— (VE/A2é€šç”¨) */
        #reaction-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.95); border: 2px solid #f39c12;
            padding: 20px; border-radius: 10px; z-index: 300; display: none;
            text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); min-width: 250px;
        }
        #reaction-msg { margin-bottom: 15px; font-weight: bold; font-size: 16px; line-height: 1.5; }
        .react-btn { padding: 8px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; margin: 0 10px; font-size: 14px; transition: 0.2s; }
        .btn-reject { background: #e74c3c; color: white; } 
        .btn-accept { background: #2ecc71; color: white; }
        .react-btn:hover { transform: scale(1.1); }

    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h1>ğŸ¥£ è°æ˜¯ä¸­æ¯ï¼Ÿ</h1>
            <input type="text" id="nickname-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="8">
            <input type="text" id="room-input" placeholder="è¯·è¾“å…¥æˆ¿é—´å·">
            <button onclick="joinRoom()">å¼€å§‹å¯¹æˆ˜</button>
            <p id="login-msg" style="color: #e74c3c; margin: 0; font-size: 14px; height: 20px;"></p>
        </div>
    </div>

    <div id="main-ui">
        <div id="status-bar">
            <span id="room-display" style="color:#bdc3c7; font-size:18px;"></span>
            <span id="turn-info">ç­‰å¾…å¯¹æ‰‹...</span>
        </div>
        <div id="main-area">
            <div class="sidebar" id="sidebar-A">
                <h3 class="team-title-A" id="title-A">Aæ–¹</h3>
                <div id="list-A"></div>
            </div>

            <div id="game-container">
                <canvas id="boardCanvas" width="500" height="500"></canvas>
                <div id="click-layer"></div>
                <div id="pieces-layer"></div>
                
                <div id="skill-panel">
                    <button id="skill-btn" class="skill-btn" onclick="handleSkillBtnClick()">ğŸš€ å‘åŠ¨æŠ€èƒ½</button>
                </div>

                <div id="reaction-panel">
                    <div id="reaction-msg">...</div>
                    <button class="react-btn btn-reject">No</button>
                    <button class="react-btn btn-accept">Yes</button>
                </div>
            </div>

            <div class="sidebar" id="sidebar-B">
                <h3 class="team-title-B" id="title-B">Bæ–¹</h3>
                <div id="list-B"></div>
            </div>
        </div>

        <div id="log-area"><div style="color: #aaa; text-align: center;">--- æˆ˜æ–—è®°å½• ---</div></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const GRID_SIZE = 6;  
        const BOARD_WIDTH = 500;
        const PADDING = 35;
        const STEP = (BOARD_WIDTH - PADDING * 2) / GRID_SIZE;
        let myId = null;
        let myTeam = null;
        
        let isSkillTargeting = false; 
        let currentSkillType = null; 
        let dragonStage = 0;
        let dragonEnemyPos = null;

        // å…¨å±€æ£‹ç›˜æ•°æ®ç¼“å­˜ (ç”¨äºç‚¹å‡»åˆ¤å®š)
        let globalBoardData = [];

        // --- ç™»å½•é€»è¾‘ ---
        function joinRoom() {
            const nickname = document.getElementById('nickname-input').value.trim();
            const roomId = document.getElementById('room-input').value.trim();
            if (!nickname) { document.getElementById('login-msg').innerText = "åå­—ä¸èƒ½ä¸ºç©ºï¼"; return; }
            if (!roomId) { document.getElementById('login-msg').innerText = "æˆ¿é—´å·ä¸èƒ½ä¸ºç©ºï¼"; return; }
            socket.emit('join_room', { roomId, nickname });
        }
        socket.on('join_success', (roomId) => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('room-display').innerText = `æˆ¿é—´: ${roomId}`;
            drawBoard(); initClickLayer();
        });
        socket.on('join_fail', (msg) => { document.getElementById('login-msg').innerText = msg; });

        function updateNames(names) {
            if (names && names.A) document.getElementById('title-A').innerText = names.A;
            if (names && names.B) document.getElementById('title-B').innerText = names.B;
        }

        function renderSidebars(queues) {
            ['A', 'B'].forEach(team => {
                const container = document.getElementById(`list-${team}`);
                container.innerHTML = ''; 
                queues[team].forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'queue-item';
                    if (item.isDead) div.classList.add('dead');
                    if (item.isCurrent) div.classList.add('current');
                    div.innerHTML = `<div class="q-header"><span class="q-name">${item.name}</span><span class="q-hp">â¤ï¸ ${item.hp}</span></div><div class="q-rank">${item.rankTitle}</div>`;
                    container.appendChild(div);
                });
            });
        }

        function renderPieces(data) {
            globalBoardData = data.board; // æ›´æ–°å…¨å±€ç¼“å­˜
            
            const layer = document.getElementById('pieces-layer');
            layer.innerHTML = ''; 
            
            const btn = document.getElementById('skill-btn');
            if (!isSkillTargeting) {
                btn.style.display = 'none';
                btn.classList.remove('targeting');
                currentSkillType = null;
            }

            if (!data.pendingDecisionType) {
                document.getElementById('reaction-panel').style.display = 'none';
            }

            data.board.forEach(p => {
                const el = document.createElement('div');
                el.className = `piece team-${p.team}`;
                el.style.left = (PADDING + p.x * STEP) + 'px';
                el.style.top = (PADDING + p.y * STEP) + 'px';
                
                if (p.isChimeraActive) el.classList.add('chimera-active');
                if (p.isFrozen) {
                    el.style.filter = "grayscale(100%) opacity(0.8)";
                    el.style.transform = "translate(-50%, -50%) scale(0.9)"; 
                }
                if (p.isVulnerable) el.style.border = "3px dashed #e74c3c";
                if (p.isSilenced) el.style.boxShadow = "0 0 0 3px #9b59b6"; 

                let displayName = p.name;
                if (displayName.length === 4) displayName = displayName.substring(0, 2) + '<br>' + displayName.substring(2);
                el.innerHTML = `<div class="p-name" style="line-height: 1.1;">${displayName}</div>`;
                el.title = `${p.name}: ${p.desc}`;
                
                if (data.turn && data.turn.x === p.x && data.turn.y === p.y) {
                    if (data.myTeam === data.turn.team) {
                        el.classList.add('active'); 
                        const sid = p.skillId;
                        if (sid === 'silverash') {
                            btn.innerHTML = `ğŸ‘ï¸ é¹°çœ¼è§†è§‰`; btn.style.display = 'block'; currentSkillType = 'silverash';
                        } else if (sid === 'mlynar') {
                            btn.innerHTML = `ğŸ“° çœ‹æŠ¥çº¸`; btn.style.display = 'block'; currentSkillType = 'mlynar';
                        } else if (sid === 'amiya' && !p.isChimeraActive) { 
                            btn.innerHTML = `ğŸ”¥ å¥‡ç¾æ‹‰`; btn.style.display = 'block'; currentSkillType = 'amiya';
                        } else if (sid === 'mensa') {
                            btn.innerHTML = `ğŸ“‹ è€ƒæ ¸æœŸ`; btn.style.display = 'block'; currentSkillType = 'mensa';
                        } else if (sid === 'ray') {
                            btn.innerHTML = `ğŸ¯ æ²™åœ°å…½(ç‹™å‡»)`; btn.style.display = 'block'; currentSkillType = 'ray';
                        } else if (sid === 'ycyx') {
                            btn.innerHTML = `ğŸ’Œ æˆ‘å–œæ¬¢ä½ (ç¦é­”)`; btn.style.display = 'block'; currentSkillType = 'ycyx';
                        } else if (sid === 'yellow') {
                            btn.innerHTML = `ğŸ§¹ åå¤´æ´¾æ¸…æ´—`; btn.style.display = 'block'; currentSkillType = 'yellow';
                        } else if (sid === 'dragon') {
                            btn.innerHTML = `ğŸ² ç ´ç¢å¤§é“/é²œè”¬æ¯`; btn.style.display = 'block'; currentSkillType = 'dragon';
                        } else if (sid === 'zhipao') {
                            btn.innerHTML = `ğŸ© é­”æœ¯å¸ˆ(æ¢ä½)`; btn.style.display = 'block'; currentSkillType = 'zhipao';
                        }
                    }
                }
                
                el.onclick = (e) => { e.stopPropagation(); handleGridClick(p.x, p.y); };
                layer.appendChild(el);
            });

            const turnInfo = document.getElementById('turn-info');
            const names = data.playerNames || {A:'Aæ–¹', B:'Bæ–¹'};
            if (data.winner) turnInfo.innerText = `ğŸ† èƒœè€…: ${names[data.winner]}`;
            else if (data.turn) turnInfo.innerText = `å½“å‰å›åˆ: ${names[data.turn.team]} [${data.turn.name} - ${data.turn.rankTitle}]`;
            myTeam = data.myTeam;
            updateNames(data.playerNames);
            
            if (data.systemLogs && data.systemLogs.length > 0) {
                data.systemLogs.forEach(log => {
                    addLog(`<span style="color:#e67e22; font-weight:bold;">âš ï¸ ${log}</span>`);
                });
            }
        }

        // --- æŠ€èƒ½æŒ‰é’®ç‚¹å‡»é€»è¾‘ ---
        function handleSkillBtnClick() {
            if (currentSkillType === 'mlynar') {
                if (confirm("ç¡®å®šè¦ã€çœ‹æŠ¥çº¸ã€‘æ‘¸é±¼å—ï¼Ÿ(ç­‰çº§+1ï¼Œç»“æŸå›åˆ)")) socket.emit('use_skill', { x: 0, y: 0 });
            } else if (currentSkillType === 'amiya') {
                if (confirm("ç¡®å®šè¦å¼€å¯ã€å¥‡ç¾æ‹‰ã€‘å—ï¼Ÿ(ä¸‹ä¸€æ¬¡æ”»å‡»å¿…èƒœ)")) socket.emit('use_skill', { x: 0, y: 0 });
            } else if (currentSkillType === 'yellow') {
                if (confirm("ç¡®å®šè¦å‘åŠ¨ã€åå¤´æ´¾æ¸…æ´—ã€‘å—ï¼Ÿ(ä¸æ­»ä¸ä¼‘ï¼Œæ”»å‡»å…¨åœºæ‰€æœ‰æ•Œæ–¹æ·€ç²‰è§’è‰²)")) socket.emit('use_skill', { x: 0, y: 0 });
            } else if (currentSkillType === 'silverash') {
                toggleSkillMode();
            } else if (currentSkillType === 'mensa') {
                alert("è¯·ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªæ•Œæ–¹å•ä½è¿›è¡Œè€ƒæ ¸");
                toggleSkillMode();
            } else if (currentSkillType === 'ray') {
                alert("è¯·ç‚¹å‡»ä»»æ„ä¸€ä¸ªæ•Œæ–¹å•ä½è¿›è¡Œå…¨å›¾ç‹™å‡»");
                toggleSkillMode();
            } else if (currentSkillType === 'ycyx') {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªã€å‘¨å›´å…«æ ¼ã€‘å†…çš„æ•Œæ–¹å•ä½");
                toggleSkillMode();
            } else if (currentSkillType === 'dragon') {
                dragonStage = 0; dragonEnemyPos = null;
                alert("é¾™å“¥å“¥æŠ€èƒ½æ¨¡å¼ï¼š\n1. ç‚¹å‡»ã€åŒè¡Œ/åŒåˆ—ã€‘è§¦å‘åœ°ç«(AOE)\n2. ç‚¹å‡»ã€å‘¨å›´æ•Œæ–¹ã€‘è§¦å‘é²œè”¬æ¯(ç¬¬ä¸€æ­¥é€‰æ•Œï¼Œç¬¬äºŒæ­¥é€‰å‹)");
                toggleSkillMode();
            } else if (currentSkillType === 'zhipao') {
                alert("è¯·ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªé˜Ÿå‹è¿›è¡Œä½ç½®äº¤æ¢");
                toggleSkillMode();
            }
        }

        // --- åˆ‡æ¢æŠ€èƒ½ç„å‡†æ¨¡å¼ ---
        function toggleSkillMode() {
            const btn = document.getElementById('skill-btn');
            isSkillTargeting = !isSkillTargeting;
            if (isSkillTargeting) {
                btn.innerHTML = "âŒ å–æ¶ˆé€‰æ‹©";
                btn.classList.add('targeting');
            } else {
                dragonStage = 0; dragonEnemyPos = null; 
                if (currentSkillType === 'silverash') btn.innerHTML = "ğŸ‘ï¸ é¹°çœ¼è§†è§‰";
                else if (currentSkillType === 'mensa') btn.innerHTML = "ğŸ“‹ è€ƒæ ¸æœŸ";
                else if (currentSkillType === 'ray') btn.innerHTML = "ğŸ¯ æ²™åœ°å…½(ç‹™å‡»)";
                else if (currentSkillType === 'ycyx') btn.innerHTML = "ğŸ’Œ æˆ‘å–œæ¬¢ä½ (ç¦é­”)";
                else if (currentSkillType === 'dragon') btn.innerHTML = "ğŸ² ç ´ç¢å¤§é“/é²œè”¬æ¯";
                else if (currentSkillType === 'zhipao') btn.innerHTML = "ğŸ© é­”æœ¯å¸ˆ(æ¢ä½)";
                btn.classList.remove('targeting');
            }
        }

        // --- æ£‹ç›˜ç‚¹å‡»å¤„ç† ---
        function handleGridClick(x, y) {
            if (isSkillTargeting) {
                if (currentSkillType === 'dragon') {
                    if (dragonStage === 0) {
                        const target = globalBoardData.find(p => p.x === x && p.y === y);
                        if (target && target.team !== myTeam) {
                            if (confirm(`é€‰ä¸­äº†æ•Œäºº [${target.name}]ï¼Œæ˜¯å¦è¦å‘åŠ¨ã€é²œè”¬æ¯ã€‘ï¼Ÿ\n(ç‚¹å‡»ç¡®å®šåï¼Œè¯·å†é€‰æ‹©ä¸€ä¸ªå‘¨å›´çš„é˜Ÿå‹)`)) {
                                dragonStage = 1;
                                dragonEnemyPos = { x, y };
                                return; 
                            }
                        }
                        socket.emit('use_skill', { x, y });
                        toggleSkillMode();
                    } 
                    else if (dragonStage === 1) {
                        socket.emit('use_skill', { 
                            x: dragonEnemyPos.x,
                            y: dragonEnemyPos.y,
                            allyX: x,            
                            allyY: y 
                        });
                        toggleSkillMode();
                    }
                } else {
                    socket.emit('use_skill', { x, y });
                    toggleSkillMode(); 
                }
            } else {
                socket.emit('move', { x, y });
            }
        }

        function drawBoard() {
            const ctx = document.getElementById('boardCanvas').getContext('2d');
            ctx.clearRect(0, 0, 500, 500);
            const getPos = i => PADDING + i * STEP;
            ctx.strokeStyle = "#7f8c8d"; ctx.lineWidth = 2; ctx.lineCap = "round";
            for (let i = 0; i <= 6; i++) {
                ctx.beginPath(); ctx.moveTo(getPos(0), getPos(i)); ctx.lineTo(getPos(6), getPos(i)); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(getPos(i), getPos(0)); ctx.lineTo(getPos(i), getPos(6)); ctx.stroke();
            }
            ctx.strokeStyle = "#c0392b"; ctx.lineWidth = 5; 
            ctx.beginPath();
            ctx.moveTo(getPos(0), getPos(0)); ctx.lineTo(getPos(2), getPos(2));
            ctx.moveTo(getPos(2), getPos(0)); ctx.lineTo(getPos(0), getPos(2));
            ctx.moveTo(getPos(2), getPos(2)); ctx.lineTo(getPos(0), getPos(4));
            ctx.moveTo(getPos(2), getPos(2)); ctx.lineTo(getPos(2), getPos(6));
            ctx.moveTo(getPos(2), getPos(6)); ctx.lineTo(getPos(1), getPos(5));
            ctx.moveTo(getPos(3), getPos(0)); ctx.lineTo(getPos(4), getPos(1));
            ctx.moveTo(getPos(3), getPos(1)); ctx.lineTo(getPos(5), getPos(1));
            ctx.moveTo(getPos(3), getPos(2)); ctx.lineTo(getPos(5), getPos(2));
            ctx.moveTo(getPos(3), getPos(3)); ctx.lineTo(getPos(5), getPos(3));
            ctx.moveTo(getPos(3), getPos(1)); ctx.lineTo(getPos(3), getPos(6));
            ctx.moveTo(getPos(5), getPos(1)); ctx.lineTo(getPos(5), getPos(3));
            ctx.moveTo(getPos(3), getPos(3)); ctx.lineTo(getPos(6), getPos(6));
            ctx.moveTo(getPos(3), getPos(6)); ctx.lineTo(getPos(4), getPos(5));
            ctx.moveTo(getPos(5), getPos(3)); ctx.lineTo(getPos(4), getPos(4));
            ctx.stroke();
        }

        function initClickLayer() {
            const layer = document.getElementById('click-layer');
            layer.innerHTML = '';
            for(let y=0; y<=6; y++) for(let x=0; x<=6; x++) {
                const div = document.createElement('div');
                div.className = 'grid-click-area';
                div.style.left = (PADDING + x * STEP) + 'px';
                div.style.top = (PADDING + y * STEP) + 'px';
                div.onclick = () => handleGridClick(x, y);
                layer.appendChild(div);
            }
        }
        
        function addLog(html) {
            const logArea = document.getElementById('log-area');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `[${new Date().toLocaleTimeString().slice(0,5)}] ${html}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight; 
        }

        socket.on('connect', () => { myId = socket.id; });
        socket.on('game_init', (data) => { 
            document.getElementById('turn-info').innerText = data.msg; 
            addLog(`<span style="color:#2ecc71">${data.msg}</span>`);
        });
        socket.on('update_board', (data) => { renderPieces(data); if (data.queues) renderSidebars(data.queues); });
        socket.on('error_msg', (msg) => { addLog(`<span style="color:#e74c3c">âŒ ${msg}</span>`); if(isSkillTargeting) toggleSkillMode(); });
        
        socket.on('combat_effect', (res) => {
            const attName = res.attackerName; const defName = res.defenderName;
            const attRank = (res.attackerTeam === myTeam) ? res.attackerRank : '???';
            const defRank = (res.defenderTeam === myTeam) ? res.defenderRank : '???';
            let logHtml = `<span class="log-highlight">${attName}</span>(${attRank}) âš”ï¸ <span class="log-highlight">${defName}</span>(${defRank}) `;
            if (res.winner === 'draw') logHtml += `-> <span style="color:#aaa">å¹³æ‰‹ (å„-1è¡€)</span>`;
            else { const winnerName = (res.winner === 'attacker') ? attName : defName; logHtml += `-> <span class="log-win">${winnerName} è·èƒœ!</span>`; }
            
            if (res.specialLog) {
                logHtml += `<br><span class="log-special">${res.specialLog}</span>`;
            }

            addLog(logHtml);
        });

        socket.on('skill_log', (msg) => { addLog(`<span style="color:#9b59b6">ğŸ‘ï¸ ${msg}</span>`); });
        
        socket.on('skill_reaction_request', (data) => {
            const panel = document.getElementById('reaction-panel');
            const msgDiv = document.getElementById('reaction-msg');
            const btnReject = document.querySelector('.btn-reject');
            const btnAccept = document.querySelector('.btn-accept');

            const newBtnReject = btnReject.cloneNode(true);
            const newBtnAccept = btnAccept.cloneNode(true);
            btnReject.parentNode.replaceChild(newBtnReject, btnReject);
            btnAccept.parentNode.replaceChild(newBtnAccept, btnAccept);

            if (data.type === 've_reject') {
                msgDiv.innerText = "å¯¹æ–¹å‘èµ·å†³æ–—ï¼æ˜¯å¦å‘åŠ¨ã€åé©³å‹äººæ ¼ã€‘æ‹’ç»å†³æ–—ï¼Ÿ";
                newBtnReject.innerText = "ğŸš« æ‹’ç»"; 
                newBtnReject.onclick = () => { socket.emit('resolve_duel', { accept: false }); panel.style.display = 'none'; };
                newBtnAccept.innerText = "âš”ï¸ æ¥å—"; 
                newBtnAccept.onclick = () => { socket.emit('resolve_duel', { accept: true }); panel.style.display = 'none'; };
                panel.style.display = 'block';
            } 
            else if (data.type === 'a2_regret') {
                msgDiv.innerText = "æˆ˜æ–—å·²ç»“ç®—ã€‚æ˜¯å¦å‘åŠ¨ã€å·¦å³äº’æã€‘è¿›è¡Œæ‚”æ£‹ï¼Ÿ(æ—¶é—´å€’æµ)";
                newBtnReject.innerText = "âŒ ä¸æ‚”æ£‹"; 
                newBtnReject.onclick = () => { socket.emit('resolve_a2_regret', { regret: false }); panel.style.display = 'none'; };
                newBtnAccept.innerText = "â³ æ‚”æ£‹";   
                newBtnAccept.onclick = () => { socket.emit('resolve_a2_regret', { regret: true }); panel.style.display = 'none'; };
                panel.style.display = 'block';
            }
        });

        drawBoard(); initClickLayer();
    </script>
</body>
</html>